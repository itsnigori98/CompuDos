<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdminController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SpringBoot1</a> &gt; <a href="index.source.html" class="el_package">edu.icesi.fitness.controller</a> &gt; <span class="el_source">AdminController.java</span></div><h1>AdminController.java</h1><pre class="source lang-java linenums">package edu.icesi.fitness.controller;

import com.fasterxml.jackson.annotation.JsonFormat;
import edu.icesi.fitness.model.Event;
import edu.icesi.fitness.model.Exercise;
import edu.icesi.fitness.model.Notification;
import edu.icesi.fitness.model.User;
import edu.icesi.fitness.repository.EventRepository;
import edu.icesi.fitness.repository.ExerciseRepository;
import edu.icesi.fitness.repository.NotificationRepository;
import edu.icesi.fitness.repository.PermissionRepository;
import edu.icesi.fitness.repository.ProgressRepository;
import edu.icesi.fitness.repository.RoleRepository;
import edu.icesi.fitness.repository.RoutineRepository;
import edu.icesi.fitness.repository.TrainerRepository;
import edu.icesi.fitness.repository.UserRepository;
import edu.icesi.fitness.service.PermissionService;
import edu.icesi.fitness.service.RoleService;
import edu.icesi.fitness.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.server.ResponseStatusException;

import java.util.*;

@RestController
@RequestMapping(&quot;/api/admin&quot;)
<span class="nc" id="L30">public class AdminController {</span>

    // ======== Services (idempotentes) ========
    @Autowired private UserService userService;
    @Autowired private RoleService roleService;
    @Autowired private PermissionService permissionService;

    // ======== Repositories para queries y catálogos ========
    @Autowired private UserRepository userRepository;
    @Autowired private RoleRepository roleRepository;
    @Autowired private PermissionRepository permissionRepository;
    @Autowired private RoutineRepository routineRepository;
    @Autowired private ExerciseRepository exerciseRepository;
    @Autowired private ProgressRepository progressRepository;
    @Autowired private NotificationRepository notificationRepository;
    @Autowired private TrainerRepository trainerRepository;
    @Autowired private EventRepository eventRepository;

    // ------------------------------------------------
    //                  QUERIES (TALLER)
    // ------------------------------------------------

    // ejercicio1: usuarios por rol &quot;ROLE_USER&quot;
    @GetMapping(&quot;ejercicio1&quot;)
    public ResponseEntity&lt;?&gt; ejercicio1() {
<span class="nc" id="L55">        var output = userRepository.findByRoles_NameOrderByIdAsc(&quot;ROLE_USER&quot;);</span>
<span class="nc" id="L56">        return ResponseEntity.ok(output);</span>
    }

    // ejercicio2: rutinas del usuario id=1
    @GetMapping(&quot;ejercicio2&quot;)
    public ResponseEntity&lt;?&gt; ejercicio2() {
<span class="nc" id="L62">        var output = routineRepository.findByUsers_IdOrderByIdAsc(1);</span>
<span class="nc" id="L63">        return ResponseEntity.ok(output);</span>
    }

    // ejercicio3: último progreso del usuario id=2 (ordenado por fecha desc)
    @GetMapping(&quot;ejercicio3&quot;)
    public ResponseEntity&lt;?&gt; ejercicio3() {
<span class="nc" id="L69">        var output = progressRepository.findTopByUser_IdOrderByDateDesc(2).orElse(null);</span>
<span class="nc" id="L70">        return ResponseEntity.ok(output);</span>
    }

    // ejercicio4: ejercicios cuyo nombre contiene &quot;press&quot;
    @GetMapping(&quot;ejercicio4&quot;)
    public ResponseEntity&lt;?&gt; ejercicio4() {
<span class="nc" id="L76">        var output = exerciseRepository.findByNameContainingIgnoreCaseOrderByIdAsc(&quot;press&quot;);</span>
<span class="nc" id="L77">        return ResponseEntity.ok(output);</span>
    }

    // ejercicio5: notificaciones del usuario id=1
    @GetMapping(&quot;ejercicio5&quot;)
    public ResponseEntity&lt;?&gt; ejercicio5() {
<span class="nc" id="L83">        var output = notificationRepository.findByUsers_IdOrderByIdAsc(1);</span>
<span class="nc" id="L84">        return ResponseEntity.ok(output);</span>
    }

    // ejercicio6: próximos eventos (desde ahora)
    @GetMapping(&quot;ejercicio6&quot;)
    public ResponseEntity&lt;?&gt; ejercicio6() {
<span class="nc" id="L90">        var output = eventRepository.findByDateAfterOrderByDateAsc(new Date());</span>
<span class="nc" id="L91">        return ResponseEntity.ok(output);</span>
    }

    // ejercicio7: eventos en los que participa el usuario id=2
    @GetMapping(&quot;ejercicio7&quot;)
    public ResponseEntity&lt;?&gt; ejercicio7() {
<span class="nc" id="L97">        var output = eventRepository.findByUsers_IdOrderByDateAsc(2);</span>
<span class="nc" id="L98">        return ResponseEntity.ok(output);</span>
    }

    // ejercicio8: usuarios por rango de edad 18..30
    @GetMapping(&quot;ejercicio8&quot;)
    public ResponseEntity&lt;?&gt; ejercicio8() {
<span class="nc" id="L104">        var output = userRepository.findByAgeBetweenOrderByAgeAsc(18, 30);</span>
<span class="nc" id="L105">        return ResponseEntity.ok(output);</span>
    }

    // ejercicio9: trainers por especialidad que contenga &quot;Bici&quot;
    @GetMapping(&quot;ejercicio9&quot;)
    public ResponseEntity&lt;?&gt; ejercicio9() {
<span class="nc" id="L111">        var output = trainerRepository.findBySpecialtyContainingIgnoreCaseOrderByIdAsc(&quot;Bici&quot;);</span>
<span class="nc" id="L112">        return ResponseEntity.ok(output);</span>
    }

    // ejercicio10: eventos ligados a la notificación id=1
    @GetMapping(&quot;ejercicio10&quot;)
    public ResponseEntity&lt;?&gt; ejercicio10() {
<span class="nc" id="L118">        var output = eventRepository.findByNotificationId_IdOrderByDateAsc(1);</span>
<span class="nc" id="L119">        return ResponseEntity.ok(output);</span>
    }

    // ------------------------------------------------
    //                    USERS (Admin)
    // ------------------------------------------------
<span class="nc" id="L125">    public static class CreateUserDto {</span>
        public String name;
        public String email;
        public String password;
        public Set&lt;String&gt; roles; // opcional: extra roles además de ROLE_USER
    }
<span class="nc" id="L131">    public static class UpdateUserDto {</span>
        public String name;
        public String email;
        public String password;
    }

    @GetMapping(&quot;/users&quot;)
    public ResponseEntity&lt;List&lt;User&gt;&gt; listUsers() {
<span class="nc" id="L139">        return ResponseEntity.ok(userService.listAll());</span>
    }

    @GetMapping(&quot;/users/{id}&quot;)
    public ResponseEntity&lt;User&gt; getUser(@PathVariable Long id) {
<span class="nc" id="L144">        return ResponseEntity.ok(userService.getById(id));</span>
    }

    @PostMapping(value = &quot;/users&quot;, consumes = &quot;application/json&quot;)
    public ResponseEntity&lt;User&gt; createUser(@RequestBody CreateUserDto dto) {
<span class="nc" id="L149">        User u = userService.createUser(dto.name, dto.email, dto.password, dto.roles);</span>
<span class="nc" id="L150">        return new ResponseEntity&lt;&gt;(u, HttpStatus.CREATED);</span>
    }

    @PutMapping(value = &quot;/users/{id}&quot;, consumes = &quot;application/json&quot;)
    public ResponseEntity&lt;User&gt; updateUser(@PathVariable Integer id, @RequestBody UpdateUserDto dto) {
<span class="nc" id="L155">        User u = userService.updateBasicInfo(id, dto.name, dto.email, dto.password);</span>
<span class="nc" id="L156">        return ResponseEntity.ok(u);</span>
    }

    @PutMapping(value = &quot;/users/{id}/roles&quot;, consumes = &quot;application/json&quot;)
    public ResponseEntity&lt;User&gt; setUserRoles(@PathVariable Integer id, @RequestBody Set&lt;String&gt; roleNames) {
<span class="nc" id="L161">        return ResponseEntity.ok(userService.setRoles(id, roleNames));</span>
    }

    @PostMapping(&quot;/users/{id}/roles/{roleName}&quot;)
    public ResponseEntity&lt;User&gt; addRoleToUser(@PathVariable Integer id, @PathVariable String roleName) {
<span class="nc" id="L166">        return ResponseEntity.ok(userService.addRole(id, roleName));</span>
    }

    @DeleteMapping(&quot;/users/{id}/roles/{roleName}&quot;)
    public ResponseEntity&lt;User&gt; removeRoleFromUser(@PathVariable Integer id, @PathVariable String roleName) {
<span class="nc" id="L171">        return ResponseEntity.ok(userService.removeRole(id, roleName));</span>
    }

    @DeleteMapping(&quot;/users/{id}&quot;)
    public ResponseEntity&lt;Void&gt; deleteUser(@PathVariable Integer id) {
<span class="nc" id="L176">        userService.deleteUser(id);</span>
<span class="nc" id="L177">        return ResponseEntity.noContent().build();</span>
    }

    // ------------------------------------------------
    //                    ROLES (Admin)
    // ------------------------------------------------
<span class="nc" id="L183">    public static class RoleCreateDto {</span>
        public String name;
        public Set&lt;String&gt; permissions; // opcional; &quot;app:view&quot; se agrega siempre
    }
<span class="nc" id="L187">    public static class RolePermissionsDto {</span>
        public Set&lt;String&gt; permissions;
    }

    @GetMapping(&quot;/roles&quot;)
    public ResponseEntity&lt;?&gt; listRoles() {
<span class="nc" id="L193">        return ResponseEntity.ok(roleService.listAll());</span>
    }

    @GetMapping(&quot;/roles/{name}&quot;)
    public ResponseEntity&lt;?&gt; getRole(@PathVariable String name) {
<span class="nc" id="L198">        return ResponseEntity.ok(roleService.getByName(name));</span>
    }

    @PostMapping(value = &quot;/roles&quot;, consumes = &quot;application/json&quot;)
    public ResponseEntity&lt;?&gt; createRole(@RequestBody RoleCreateDto dto) {
<span class="nc bnc" id="L203" title="All 6 branches missed.">        if (dto == null || dto.name == null || dto.name.isBlank()) {</span>
<span class="nc" id="L204">            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Role name is required&quot;);</span>
        }
<span class="nc" id="L206">        return new ResponseEntity&lt;&gt;(roleService.createRole(dto.name, dto.permissions), HttpStatus.CREATED);</span>
    }

    @PutMapping(value = &quot;/roles/{name}/permissions&quot;, consumes = &quot;application/json&quot;)
    public ResponseEntity&lt;?&gt; setRolePermissions(@PathVariable String name, @RequestBody RolePermissionsDto body) {
<span class="nc bnc" id="L211" title="All 2 branches missed.">        Set&lt;String&gt; perms = (body == null ? Collections.emptySet() : body.permissions);</span>
<span class="nc" id="L212">        return ResponseEntity.ok(roleService.setPermissions(name, perms));</span>
    }

    @PostMapping(&quot;/roles/{name}/permissions/{permissionName}&quot;)
    public ResponseEntity&lt;?&gt; addPermissionToRole(@PathVariable String name, @PathVariable String permissionName) {
<span class="nc" id="L217">        return ResponseEntity.ok(roleService.addPermission(name, permissionName));</span>
    }

    @DeleteMapping(&quot;/roles/{name}/permissions/{permissionName}&quot;)
    public ResponseEntity&lt;?&gt; removePermissionFromRole(@PathVariable String name, @PathVariable String permissionName) {
<span class="nc" id="L222">        return ResponseEntity.ok(roleService.removePermission(name, permissionName));</span>
    }

    @DeleteMapping(&quot;/roles/{name}&quot;)
    public ResponseEntity&lt;Void&gt; deleteRole(@PathVariable String name) {
<span class="nc" id="L227">        roleService.delete(name);</span>
<span class="nc" id="L228">        return ResponseEntity.noContent().build();</span>
    }

    // ------------------------------------------------
    //                 PERMISSIONS (Admin)
    // ------------------------------------------------
    @PostMapping(value = &quot;/permissions&quot;, consumes = &quot;application/json&quot;)
    public ResponseEntity&lt;?&gt; createPermission(@RequestBody String name) {
<span class="nc bnc" id="L236" title="All 4 branches missed.">        if (name == null || name.isBlank()) {</span>
<span class="nc" id="L237">            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Permission name is required&quot;);</span>
        }
<span class="nc" id="L239">        return new ResponseEntity&lt;&gt;(permissionService.create(name), HttpStatus.CREATED);</span>
    }

    @GetMapping(&quot;/permissions&quot;)
    public ResponseEntity&lt;?&gt; listPermissions() {
<span class="nc" id="L244">        return ResponseEntity.ok(permissionService.listAll());</span>
    }

    @GetMapping(&quot;/permissions/{name}&quot;)
    public ResponseEntity&lt;?&gt; getPermission(@PathVariable String name) {
<span class="nc" id="L249">        return ResponseEntity.ok(permissionService.getByName(name));</span>
    }

    @DeleteMapping(&quot;/permissions/{name}&quot;)
    public ResponseEntity&lt;Void&gt; deletePermission(@PathVariable String name) {
<span class="nc" id="L254">        permissionService.deleteByName(name);</span>
<span class="nc" id="L255">        return ResponseEntity.noContent().build();</span>
    }

    // ------------------------------------------------
//            EXERCISES (catálogo – Admin)
// ------------------------------------------------
<span class="nc" id="L261">    public static class ExerciseUpsertDto {</span>
        public String name;
        public String type;
        public String description;
        public String videoUrl;
    }

    @PostMapping(value = &quot;/exercises&quot;, consumes = &quot;application/json&quot;)
    public ResponseEntity&lt;Exercise&gt; createExercise(@RequestBody ExerciseUpsertDto dto) {
<span class="nc bnc" id="L270" title="All 4 branches missed.">        if (dto.name == null || dto.name.isBlank()) {</span>
<span class="nc" id="L271">            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Exercise.name is required&quot;);</span>
        }
<span class="nc" id="L273">        Exercise e = new Exercise();</span>
<span class="nc" id="L274">        e.setName(dto.name);</span>
<span class="nc" id="L275">        e.setType(dto.type);</span>
<span class="nc" id="L276">        e.setDescription(dto.description);</span>
<span class="nc" id="L277">        e.setVideoUrl(dto.videoUrl);</span>
<span class="nc" id="L278">        return new ResponseEntity&lt;&gt;(exerciseRepository.save(e), HttpStatus.CREATED);</span>
    }

    @PutMapping(value = &quot;/exercises/{id}&quot;, consumes = &quot;application/json&quot;)
    public ResponseEntity&lt;Exercise&gt; updateExercise(@PathVariable Long id, @RequestBody ExerciseUpsertDto dto) {
<span class="nc" id="L283">        Exercise e = exerciseRepository.findById(id).orElseThrow(() -&gt;</span>
<span class="nc" id="L284">                new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Exercise not found&quot;));</span>

<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (dto.name != null)        e.setName(dto.name);</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">        if (dto.type != null)        e.setType(dto.type);</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (dto.description != null) e.setDescription(dto.description);</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">        if (dto.videoUrl != null)    e.setVideoUrl(dto.videoUrl);</span>

<span class="nc" id="L291">        return ResponseEntity.ok(exerciseRepository.save(e));</span>
    }

    @DeleteMapping(&quot;/exercises/{id}&quot;)
    public ResponseEntity&lt;Void&gt; deleteExercise(@PathVariable Long id) {
<span class="nc bnc" id="L296" title="All 2 branches missed.">        if (!exerciseRepository.existsById(id)) {</span>
<span class="nc" id="L297">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Exercise not found&quot;);</span>
        }
<span class="nc" id="L299">        exerciseRepository.deleteById(id);</span>
<span class="nc" id="L300">        return ResponseEntity.noContent().build();</span>
    }



    // ------------------------------------------------
    //               EVENTS (catálogo – Admin)
    // ------------------------------------------------
<span class="nc" id="L308">    public static class EventUpsertDto {</span>
        public String name;
        @JsonFormat(pattern = &quot;yyyy-MM-dd'T'HH:mm:ss&quot;)
        public Date date;
        public Integer notificationId;
        public List&lt;Integer&gt; users; // si decides manejar participantes
    }

    @PostMapping(value = &quot;/events&quot;, consumes = &quot;application/json&quot;)
    public ResponseEntity&lt;Event&gt; createEvent(@RequestBody EventUpsertDto dto) {
<span class="nc bnc" id="L318" title="All 4 branches missed.">        if (dto.name == null || dto.name.isBlank()) {</span>
<span class="nc" id="L319">            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Event.name is required&quot;);</span>
        }
<span class="nc bnc" id="L321" title="All 2 branches missed.">        if (dto.date == null) {</span>
<span class="nc" id="L322">            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Event.date is required (ISO-8601)&quot;);</span>
        }
<span class="nc" id="L324">        Event ev = new Event();</span>
<span class="nc" id="L325">        ev.setName(dto.name);</span>
<span class="nc" id="L326">        ev.setDate(dto.date);</span>

<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (dto.notificationId != null) {</span>
<span class="nc" id="L329">            Notification notif = notificationRepository.findById(dto.notificationId).orElseThrow(() -&gt;</span>
<span class="nc" id="L330">                    new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Notification not found: &quot; + dto.notificationId));</span>
<span class="nc" id="L331">            ev.setNotificationId(notif);</span>
        }
<span class="nc" id="L333">        return new ResponseEntity&lt;&gt;(eventRepository.save(ev), HttpStatus.CREATED);</span>
    }

    @PutMapping(value = &quot;/events/{id}&quot;, consumes = &quot;application/json&quot;)
    public ResponseEntity&lt;Event&gt; updateEvent(@PathVariable Integer id, @RequestBody EventUpsertDto dto) {
<span class="nc" id="L338">        Event ev = eventRepository.findById(id).orElseThrow(() -&gt;</span>
<span class="nc" id="L339">                new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Event not found&quot;));</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">        if (dto.name != null) ev.setName(dto.name);</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if (dto.date != null) ev.setDate(dto.date);</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">        if (dto.notificationId != null) {</span>
<span class="nc" id="L343">            Notification notif = notificationRepository.findById(dto.notificationId).orElseThrow(() -&gt;</span>
<span class="nc" id="L344">                    new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Notification not found: &quot; + dto.notificationId));</span>
<span class="nc" id="L345">            ev.setNotificationId(notif);</span>
        }
<span class="nc" id="L347">        return ResponseEntity.ok(eventRepository.save(ev));</span>
    }

    @DeleteMapping(&quot;/events/{id}&quot;)
    public ResponseEntity&lt;Void&gt; deleteEvent(@PathVariable Integer id) {
<span class="nc bnc" id="L352" title="All 2 branches missed.">        if (!eventRepository.existsById(id)) {</span>
<span class="nc" id="L353">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Event not found&quot;);</span>
        }
<span class="nc" id="L355">        eventRepository.deleteById(id);</span>
<span class="nc" id="L356">        return ResponseEntity.noContent().build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>